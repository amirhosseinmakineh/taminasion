<app-layout-header></app-layout-header>

<main class="page">
  <section class="location-bar">
    <app-location-selector
      buttonLabel="جستجو"
      [enableSearchNavigation]="false"
      (search)="onLocationSearch($event)"
    ></app-location-selector>
  </section>

  <div class="topbar">
    <div class="tabset">
      <div class="tab">امتیاز بیشتر</div>
      <div class="tab is-active">ارزون‌ترین</div>
      <div class="tab">گرون‌ترین</div>
      <div class="tab">جدیدترین</div>
    </div>
    <div class="date-chip">
      <button class="btn btn--ghost" (click)="prevFilterDay()">روز قبل</button>
      <span class="sep"></span>
      <span>{{ getDayName(filterDay) }}</span>
      <span class="sep"></span>
      <button class="btn btn--ghost" (click)="nextFilterDay()">روز بعد</button>
    </div>
  </div>

  <div class="grid">
    <aside class="sidebar">
      <div class="sb-title">نوع خدمات</div>
      <label class="check" *ngFor="let service of businessServices">
        <input
          type="checkbox"
          [value]="service.serviceId"
          (change)="onServiceChange(service.serviceId, $event)"
        />
        {{ service.serviceName }}
      </label>

      <hr class="sidebar-divider" />

      <div class="sb-title">بازه قیمت</div>
      <input
        type="range"
        class="price-slider"
        [min]="minServiceAmount || 0"
        [max]="maxServiceAmount || 0"
        [(ngModel)]="filter.maxAmount"
        (ngModelChange)="onPriceChange($event)"
      />
      <div class="price-range">
        <input
          class="price-input"
          type="text"
          [value]="(minServiceAmount || 0) | number: '1.0-0':'fa'"
          readonly
        />
        <input
          class="price-input"
          type="text"
          [value]="(filter.maxAmount || 0) | number: '1.0-0':'fa'"
          readonly
        />
      </div>

      <hr class="sidebar-divider" />

      <div class="sb-title">دسته‌بندی</div>
      <label class="check" *ngFor="let cat of categories">
        <input
          type="checkbox"
          [value]="cat.categoryId"
          (change)="onCategoryChange(cat, $event)"
        />
        {{ cat.name }}
      </label>
    </aside>

    <section class="results">
      <article class="card" *ngFor="let business of businesses">
        <div class="card__row">
          <div>
            <div class="tags" *ngIf="business.achevmentNames?.length">
              <span class="tag" *ngFor="let tag of business.achevmentNames">{{ tag }}</span>
            </div>

            <h3 class="title">{{ business.businessOwnerName }}</h3>

            <div class="meta">
              <div class="meta__item">
                <img
                  class="avatar"
                  [src]="'http://localhost:5107/Images/' + business.businessLogo"
                  alt="لوگوی {{ business.businessName }}"
                />
                <div>
                  <div class="pro__name">{{ business.businessName }}</div>
                  <div class="price">{{ business.description }}</div>
                  <div class="price">از {{ business.amount | number: '1.0-0':'fa' }} تومان</div>
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <div class="meta__item">
              <ng-container *ngIf="business?.userRate != null; else noRate">
                <span
                  *ngFor="let filled of getStars(business.userRate)"
                  class="star"
                  [class.filled]="filled"
                >★</span>
              </ng-container>
              <ng-template #noRate>
                <span class="meta__rate meta__rate--muted">بدون امتیاز</span>
              </ng-template>
            </div>

            <div class="meta__item">۷:۰۰ – ۸:۰۰</div>

            <button class="btn btn--primary" (click)="openModal(business)">رزرو نوبت</button>
          </div>
        </div>
      </article>
    </section>
  </div>

  <div class="pagination">
    <button class="btn btn--ghost" (click)="prevPage()" [disabled]="filter.skip === 0">صفحه قبل</button>
    <button class="btn btn--ghost" (click)="nextPage()" [disabled]="!hasMore">صفحه بعد</button>
  </div>
</main>

<div class="modal-backdrop" *ngIf="showModal" (click)="closeModal()"></div>
<div class="modal" *ngIf="showModal">
  <div class="modal-header">
    <button class="btn btn--ghost" (click)="prevDay()" [disabled]="currentDayIndex === 0">روز قبل</button>
    <span>{{ getDayName(uniqueDays[currentDayIndex]) }}</span>
    <button class="btn btn--ghost" (click)="nextDay()" [disabled]="currentDayIndex === uniqueDays.length - 1">روز بعد</button>
  </div>
  <div class="modal-body">
    <div class="services">
      <h3>انتخاب سرویس</h3>
      <div *ngFor="let s of availableServices" class="service-row">
        <span class="service-name">{{ s.serviceName }}</span>
        <span class="service-price">{{ formatPrice(s.amount) }}</span>
        <select (change)="onTimeSelect(s.serviceId, $any($event.target).value)">
          <option value="">انتخاب زمان</option>
          <option *ngFor="let t of timesForCurrentDay" [value]="t.businessOwnerTimeId" [disabled]="t.isReserved">
            {{ t.fromTime }} - {{ t.toTime }}
          </option>
        </select>
        <button class="btn btn--primary" (click)="reserve(s.serviceId)" [disabled]="!selectedTimes[s.serviceId]">
          رزرو نهایی
        </button>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn--ghost" (click)="closeModal()">بستن</button>
  </div>
</div>
